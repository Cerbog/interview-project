<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <title>School DB</title>
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../node_modules/admin-lte/plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../node_modules/admin-lte/dist/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="../../node_modules/admin-lte/plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <!-- bootstrap -->
  <!-- <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.css"> -->
  <!-- jQuery -->
  <script src="../../node_modules/admin-lte/plugins/jquery/jquery.min.js"></script>
  <link rel="import" href="components/navbar.html">
</head>

<body class="hold-transition sidebar-mini layout-fixed" data-panel-auto-height-mode="height">
  <div class="wrapper">

    <!-- Navbar -->
    <div class="navEl">
      <script type="text/javascript">
        $(function () {
          $('.navEl').load('components/navbar.html');
        });
      </script>
    </div>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <script type="text/javascript">
        $(function () {
          $('.main-sidebar').load('components/sidebar.html', () => {
            $('li.nav-item > a[href="catalog.html"]').addClass('active');
          });
        });
      </script>
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <section class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>Catalog</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item active">Catalog</li>
              </ol>
            </div>
          </div>
        </div><!-- /.container-fluid -->
      </section>

      <!-- Main content -->
      <section class="content">
        <div class="container-fluid">
          <ul class="nav nav-tabs" id="clase_tabs">
          </ul>

          <div class="tab-content clearfix" id="clase_tab_content">
            <br>

          </div>
        </div>
        <footer class="main-footer" style="margin-left: 0;">
          <strong>&copy; 2023 <a href="http://linkedin.com/in/bogdan-cerveneak-375376246">Cerveneak Bogdan</a></strong>
        </footer>
    </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  </div>
  <!-- ./wrapper -->
   <!-- Modal -->
   <div class="modal fade" id="eleviNoteModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="eleviNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="eleviNoteModalLabel">Modal title</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="eleviNoteModalBody">
          <h3>Note:</h3>
          <table class="table table-striped table-hover">
            <thead class="table-dark">
               <th>Disciplina</th>
               <th>Nota</th>
               <th>Data</th>
               <th class="text-center">Semestrul</th>
               <th class="text-center"><button class="btn btn-sm btn-outline-light" onclick="addNota()"><i class="fas fa-plus-circle"></i></button></th>
            </thead>
            <tbody class="eleviNoteTable">
              
            </tbody>
         </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Understood</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="eleviEditNoteModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="eleviEditNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="eleviEditNoteModalLabel">Editeaza nota</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="eleviEditNoteModalBody">
          <form action="http://localhost:3500/note" method="POST" id="editNoteForm">
            <input type="hidden" name="_method" value="">
            <input type="hidden" name="n_id" value="">
            <div class="mb-3">
              <label for="disciplinaEditInput" class="form-label">Disciplina</label>
              <input type='text' class="form-control" id="disciplinaEditInput" name="disciplina" value="">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">Semestrul</span>
              <select class="form-select form-select-sm" aria-label=".form-select-sm" name="semestrul">
                <!-- <option selected></option> -->
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
              <span class="input-group-text" id="basic-addon1">Nota</span>
              <input type='number' class="form-control" id="notaEditInput" name="nota" value="">
            </div>
            
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" form="editNoteForm" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery UI 1.11.4 -->
  <script src="../../node_modules/admin-lte/plugins/jquery-ui/jquery-ui.min.js"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <!-- <script src="../../node_modules/admin-lte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script> -->
  <!-- overlayScrollbars -->
  <script src="../../node_modules/admin-lte/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
  <!-- AdminLTE App -->
  <script src="../../node_modules/admin-lte/dist/js/adminlte.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>
</body>

</html>
<script>
  axios.get("http://localhost:3500/catalog", { crossdomain: true }).then(response => {
    let clase_tabs = document.querySelector('ul#clase_tabs');
    let clase_tab_content = document.querySelector('#clase_tab_content');

    let catalog = response.data;
    console.log(catalog);

    const clase = catalog.map(elev => {
      return JSON.stringify({
        'nr_clasa': elev.clasa,
        'clasa': elev.an + "-" + elev.nume_clasa,
        'an': elev.an,
        'nume_clasa': elev.nume_clasa,
        'diriginte': elev.nume_diriginte + " " + elev.prenume_diriginte,
        'profil': elev.profil,
        'elevi': []
      });
    });


    const distClase = [...new Set(clase)];
    distClaseObj = distClase.map(c => JSON.parse(c));
    for (let i = 0; i < distClaseObj.length; i++) {
      for (let j = 0; j < catalog.length; j++) {
        if (distClaseObj[i].nr_clasa == catalog[j].clasa) {
          distClaseObj[i] = {
            ...distClaseObj[i],
            elevi: [...distClaseObj[i].elevi,
            {
              id: catalog[j].id,
              nr_matricol: catalog[j].nr_matricol,
              nume: catalog[j].nume,
              prenume: catalog[j].prenume
            }]
          }
        }
      }
    }
    console.log(distClaseObj);
    distClaseObj.forEach((clasa, index) => {
      clase_tabs.innerHTML += `<li class="nav-item">
          <a class="nav-link ${index == 0 ? 'active' : ''}" data-bs-toggle="tab" data-bs-target="#${clasa.clasa}" href="#">${clasa.clasa}</a>
        </li>`;
      clase_tab_content.innerHTML += `<div class="tab-pane fade ${index == 0 ? 'show active' : ''}" id="${clasa.clasa}">
          <h3>Clasa a ${clasa.an}-a ${clasa.nume_clasa}</h3>
          <h4>Profil: ${clasa.profil}</h4>
          <h4>Diriginte: ${clasa.diriginte}</h4>
          <h4>Elevi:</h4>
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <th>Nr. crt.</th>
              <th>Nr. matricol</th>
              <th>Nume</th>
              <th>Prenume</th>
            </thead>
            <tbody class="elevi_catalog">
              ${clasa.elevi.map((elv, index) => addTr(elv, index)).join(' ')}
            </tbody>
         </table>
				</div>`;
    })
  });

  function addTr(elv, index){
    return `<tr style="cursor: pointer;" onclick="noteElev(${elv.id}, '${elv.nume}', '${elv.prenume}')">
                <td>${index+1}</td>
                <td>${elv.nr_matricol}</td>
                <td>${elv.nume}</td>
                <td>${elv.prenume}</td>
              </tr>`;
  }
  function noteElev(id, nume, prenume) {
    $("#eleviNoteModal").modal('show');
    $("#eleviNoteModalLabel").html(nume+" "+prenume);
    let modalBody = $("#eleviNoteModalBody");
    let eleviNoteTable = document.querySelector(".eleviNoteTable");
    $(".eleviNoteTable").data("id", id);

    axios.get("http://localhost:3500/note/filter/?elev=" + id, { crossdomain: true }).then(response => {
            let note = response.data;
            // console.log(note);
            note.forEach(nota =>{
              console.log(nota);
              eleviNoteTable.innerHTML+=`<tr>
                  <td>${nota.materia}</td>
                  <td>${nota.nota}</td>
                  <td>${nota.data.substring(0, 10)}</td>
                  <td class="text-center">${nota.semestrul}</td>
                  <td class="text-center">
                    <button data-toggle="modal" class="btn btn-sm btn-outline-warning" onclick="editNota(${nota.id}, '${nota.materia}', ${nota.nota}, ${nota.semestrul})"><i class="fas fa-pen-alt"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteNota(${nota.id})"><i class="fas fa-trash-alt"></i></button>
                  </td>
                </tr>`
            })
         }); 
         return [id, nume, prenume];
  }

  function editNota(id_nota, materia, nota, semestrul){
    console.log(nota);
    $("#eleviEditNoteModal").modal("show");

    $("#disciplinaEditInput").val(materia);

    $(`select option[value='${semestrul}']`).attr("selected", true);
    $(`select option[value='${semestrul==1?2:1}']`).attr("selected", false);

    $("#notaEditInput").val(nota);
    $("input[name='n_id']").val(id_nota);
    $("input[name='_method']").val('put');
  }

  function deleteNota(nota){
    console.log(nota);
    axios.delete("http://localhost:3500/note/" + nota).then((response) => {
      console.log(response);
      location.reload();
    });
  }

  function addNota(){
    let id = $(".eleviNoteTable").data("id");
    $("input[name='_method']").val('post');
    $("input[name='n_id']").val(id);
    $("#eleviEditNoteModal").modal("show");
    console.log(id);
  }
  
  $("#eleviEditNoteModal").on('hidden.bs.modal', () =>{
    $("#disciplinaEditInput").val(null);
    $("#notaEditInput").val(null);
    $("input[name='n_id']").val(null);
      $("#eleviEditNoteModal").modal('hide');
   })
  
   $("#eleviNoteModal").on('hidden.bs.modal', () => {
    $("#eleviNoteModal").modal('dispose');
   })
</script>